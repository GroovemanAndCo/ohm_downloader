<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ohm Downloader</title>
    <style>
        body {
            background-color: #1a1c2c;
            color: #94b0c2;
            font-family: copperplate, "Arial Black";
        }

        textarea {
            background-color: #333c57;
            border-color: #566c86;
            color: #94b0c2;
        }

        h1 {
            color: #f4f4f4;
            text-align: center;
        }

        .content-wrap {
            width: 1000px;
            height: auto;
            margin-left: auto;
            margin-right: auto;
            padding-top: 1em;
            padding-bottom: 1em;
            background-color: #29366f;
            border-radius: 10px;
        }

        .wrap-normal {
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .wrap-bleed {
            width: 100%;
        }

        .info-wrap {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #json-input {
            display: block;
            width: 100%;
        }

        #info-para {
            padding-left: 10%;
            padding-right: 10%;
            padding-top: 1em;
            padding-bottom: 1em;
        }

        #info-para.info {
            background-color: #566c86;
            color: #94b0c2;
        }

        #info-para.success {
            background-color: #38b764;
            color: #a7f070;
        }

        #info-para.error {
            background-color: #5d275d;
            color: #b13e53;
        }

        /* ------------------------------------ */
        /* Projects */

        #project-list .project {
            position: relative;
            background-color: #333c57;
            color: #94b0c2;
            padding: .5em;
            border: 2px solid transparent;
            box-sizing: border-box;
            --progress: 0%;
        }

        #project-list .project:nth-child(2n) {
            background-color: #1a1c2c;
            color: #94b0c2;
        }

        #project-list .project:hover {
            border: 2px solid #ef7d57;
        }

        #project-list .project.active {
            background-color: #b13e53;
            color: #f4f4f4;
            --progress: 100%;
        }

        #project-list .project .checkbox {
            display: inline-block;
            margin-right: 1em;
        }

        #project-list .project .title {
            display: inline-block;
            max-width: 50%;
            white-space: nowrap;
            overflow: hidden;
            vertical-align: middle;
            text-overflow: ellipsis;
        }

        #project-list .project .waveform {
            position: absolute;
            right: 0;
            top: 0;
            width: 40%;
            height: 100%;
            background-color: #1a1c2c;
        }

        #project-list .project .waveform>div {
            position: absolute;
            left: 0;
            top: 0;
            background-color: #b13e53;
            width: var(--progress);
            height: 100%;
            transition: 3s width;
        }

        #project-list .project .waveform>img {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="content-wrap">
        <h1><span style="color: #ffcd75;">Ohm Studio</span> Project Downloader / Assistant</h1>
        <div class="wrap-normal">
            <textarea disabled name="" id="json-input" cols="30" rows="10" placeholder="Loading..." value=""></textarea>
            <input hidden id="submit-btn" type="button" value="Use this JSON">
            <input hidden id="begin-btn" type="button" value="Begin export process">
        </div>
        <div class="wrap-bleed info-wrap">
            <p hidden id="info-para"></p>
        </div>
        <div class="wrap-normal">
            <div hidden id="project-list">
            </div>
        </div>
    </div>
    <script>
        (async () => {
            const jsonInput = document.getElementById("json-input");
            const submitBtn = document.getElementById("submit-btn");
            const infoPara = document.getElementById("info-para");
            const beginBtn = document.getElementById("begin-btn");
            const projectList = document.getElementById("project-list");

            function showMessage(removeClasses, addClass, message) {
                if (!!message && message.length > 0) {
                    infoPara.innerText = message;
                    infoPara.removeAttribute("hidden");
                    infoPara.classList.remove(...removeClasses);
                    infoPara.classList.add(addClass);
                } else {
                    infoPara.setAttribute("hidden", "");
                }
            }

            const showError = message => showMessage(["success", "info", "warning"], "error", message);
            const showInfo = message => showMessage(["success", "error", "warning"], "info", message);
            const showSuccess = message => showMessage(["info", "error", "warning"], "success", message);

            async function downloadJson() {
                /* Sadly, due to CORS, this generally isn't going to work.
                 * But maybe somewhere there's a person with a browser
                 * that has CORS disabled. For this person, this might work.
                 * In that case: you rock, dude.
                */
                const downloadUrl = "http://www.ohmstudio.com/v3/feed/my_projects?page=0";

                let resp;
                try {
                    resp = await fetch(downloadUrl, { credentials: "include", });
                } catch (e) {
                    return;
                }

                if (!resp.ok) {
                    return;
                }

                const json = tryParseJson(await resp.text());
                return json;
            }

            function tryParseJson(str) {
                try {
                    const json = JSON.parse(str);
                    if (typeof json !== "object") {
                        return;
                    }

                    return json;
                } catch (e) {
                }
            }

            async function getJson() {
                if (jsonInput.value.length > 0) {
                    submitBtn.removeAttribute("hidden");
                    const json = tryParseJson(jsonInput.value);

                    showError();
                    if (!!json) {
                        return json;
                    } else {
                        showError("Invalid JSON, please paste it again.");
                    }
                }

                const json = await downloadJson();
                if (!!json) {
                    jsonInput.value = JSON.stringify(json);
                    return json;
                }

                jsonInput.setAttribute("placeholder", "Failed to download your JSON, please paste it manually...");
                jsonInput.removeAttribute("disabled");
                submitBtn.removeAttribute("hidden");

                return new Promise(resolve => {
                    let listener;
                    listener = submitBtn.addEventListener("click", () => {
                        submitBtn.removeEventListener("click", listener);
                        showError();

                        const json = tryParseJson(jsonInput.value);
                        if (!!!json) {
                            showError("Invalid JSON, please paste it again.");
                            return;
                        }

                        showInfo("Analyzing...");
                        const isValid = checkJsonStructure(json);

                        if (!isValid) {
                            showError("Your JSON is valid, BUT it's schema doesn't match. Make sure you've actually pasted Ohm Studio JSON.");
                            return;
                        }

                        if (!!json) {
                            resolve(json);
                        }
                    });
                });
            }

            function checkJsonStructure(json) {
                if (!!!json["result"]) return false;
                if (json.result.length > 0) {
                    if (!!!json.result[0]["title"]) return false;
                    if (!!!json.result[0]["mixdown"]) return false;
                }

                return true;
            }

            function addProject(prj) {
                const ele = document.createElement("div");
                projectList.appendChild(ele);
                ele.classList.add("project");
                ele.addEventListener("click", () => {
                    [...projectList.children].forEach(c => c.classList.remove("active"));
                    ele.classList.add("active");
                });

                const checkbox = document.createElement("input");
                ele.appendChild(checkbox);
                checkbox.setAttribute("type", "checkbox");
                checkbox.classList.add("checkbox");
                checkbox.addEventListener("change", () => {
                    const totalCount = projectList.children.length;
                    const selectedCount = projectList.querySelectorAll(".project .checkbox:checked").length;
                    const projectsWord = `project${selectedCount == 1 ? "" : "s"}`;
                    showInfo(`${selectedCount} ${projectsWord} selected, ${totalCount} total.`);
                });

                const title = document.createElement("div");
                ele.appendChild(title);
                title.classList.add("title");
                title.innerText = prj.title;
                title.setAttribute("title", prj.title);

                const waveform = document.createElement("div");
                ele.appendChild(waveform);
                waveform.classList.add("waveform");

                const waveformProgress = document.createElement("div");
                waveform.appendChild(waveformProgress);

                const waveformImg = document.createElement("img");
                waveform.appendChild(waveformImg);
                waveformImg.setAttribute("loading", "lazy"); // TODO: Not very cross-platform.
                if (!!prj.mixdown && prj.mixdown.length > 0) {
                    waveformImg.setAttribute("src", prj.mixdown[0].url_png);
                }
            }

            let json;
            for (; ;) {
                json = await getJson();
                if (!!json) {
                    break;
                }
            }

            submitBtn.setAttribute("hidden", "");
            showInfo(`${json.result.length} projects total.`);

            beginBtn.removeAttribute("hidden");
            beginBtn.addEventListener("click", () => {
                showSuccess("Work in progress :-)");
            });

            projectList.removeAttribute("hidden");
            json.result.forEach(addProject);
        })();
    </script>
</body>

</html>